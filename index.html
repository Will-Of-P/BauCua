<script type="module">
  import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.7.0/+esm";

  const CONTRACT_ADDR = "0x66f26568a1e0979024c2feE887B84E5561D7C6D0";
  const CONTRACT_ABI = [
    "function placeBet(uint8) payable",
    "event BetResult(address indexed bettor, uint8[3] results, uint256 win, uint256 fee)"
  ];

  const provider = new ethers.BrowserProvider(window.ethereum);
  const signer = await provider.getSigner();
  const contract = new ethers.Contract(CONTRACT_ADDR, CONTRACT_ABI, signer);

  const faces = [
    { id: 0, src: "1.png" },
    { id: 1, src: "2.png" },
    { id: 2, src: "3.png" },
    { id: 3, src: "4.png" },
    { id: 4, src: "5.png" },
    { id: 5, src: "6.png" }
  ];

  document.querySelectorAll(".bet-button").forEach(btn => {
    btn.addEventListener("click", async () => {
      const choice = parseInt(btn.getAttribute("data-choice"));
      const value = document.getElementById("value").value;

      setStatus("Waiting for transaction...");
      try {
        const tx = await contract.placeBet(choice, { value: ethers.parseEther(value) });
        setStatus("Waiting for confirmation...");
        const receipt = await tx.wait();
        showResult(receipt.logs.map(log => contract.interface.parseLog(log)), tx.hash);
      } catch (err) {
        setStatus("Error: " + err.message);
      }
    });
  });

  async function showResult(events, txHash) {
    const res = document.getElementById('result'); res.innerHTML = '';
    const evt = events.find(e => e.event === 'BetResult' && e.transactionHash === txHash);
    if (!evt) { setStatus('Error: no matching event'); return; }

    const { results, win } = evt.args;

    results.forEach(id => {
      const f = faces.find(x => x.id === id);
      const img = document.createElement('img');
      img.src = `game/${f.src}`;
      res.appendChild(img);
    });

    const msg = document.createElement('p');
    msg.innerText = `You won: ${ethers.formatUnits(win, 18)} MON`;
    res.appendChild(msg);

    setStatus('Result from this transaction');
  }

  function setStatus(message) {
    document.getElementById("status").innerText = message;
  }
</script>
