<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Ethers.js v5 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- Web3Modal & WalletConnect -->
  <script src="https://unpkg.com/web3modal@1.9.8/dist/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f0f0; }
    .container { text-align: center; }
    .board { display: grid; grid-template-columns: repeat(3, 100px); gap: 10px; margin-bottom: 20px; }
    .board img, .result img { width: 100px; height: 100px; border: 2px solid #333; border-radius: 10px; cursor: pointer; }
    .board img.selected { border: 4px solid red; }
    input, button { padding: 10px; font-size: 16px; margin: 5px; }
    button { background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .result { margin-top: 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
    .spinning { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    #status { color: #555; font-size: 0.9rem; margin-top: 1rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Hoo Hey How</h1>
    <div id="connectCard">
      <button id="btnConnect">Connect Wallet</button>
      <button id="btnDisconnect" style="display:none; background:#dc3545;">Disconnect Wallet</button>
      <p id="walletAddress">Not connected</p>
    </div>
    <div class="board" id="faces"></div>
    <div>
      <input type="number" id="betAmount" placeholder="Amount of MON (>= 0.01)" min="0" step="0.01" disabled />
      <button id="betBtn" disabled>Place Bet</button>
    </div>
    <div class="result" id="result"></div>
    <p id="status"></p>
  </div>

<script type="module">
  import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.7.0/+esm";

  const CONTRACT_ADDR = "0x66f26568a1e0979024c2feE887B84E5561D7C6D0";
  const CONTRACT_ABI = [
    "function placeBet(uint8) payable",
    "event BetResult(address indexed bettor, uint8[3] results, uint256 win, uint256 fee)"
  ];

  const provider = new ethers.BrowserProvider(window.ethereum);
  const signer = await provider.getSigner();
  const contract = new ethers.Contract(CONTRACT_ADDR, CONTRACT_ABI, signer);

  const faces = [
    { id: 0, src: "1.png" },
    { id: 1, src: "2.png" },
    { id: 2, src: "3.png" },
    { id: 3, src: "4.png" },
    { id: 4, src: "5.png" },
    { id: 5, src: "6.png" }
  ];

  document.querySelectorAll(".bet-button").forEach(btn => {
    btn.addEventListener("click", async () => {
      const choice = parseInt(btn.getAttribute("data-choice"));
      const value = document.getElementById("value").value;

      setStatus("Waiting for transaction...");
      try {
        const tx = await contract.placeBet(choice, { value: ethers.parseEther(value) });
        setStatus("Waiting for confirmation...");
        const receipt = await tx.wait();
        showResult(receipt.logs.map(log => contract.interface.parseLog(log)), tx.hash);
      } catch (err) {
        setStatus("Error: " + err.message);
      }
    });
  });

  async function showResult(events, txHash) {
    const res = document.getElementById('result'); res.innerHTML = '';
    const evt = events.find(e => e.event === 'BetResult' && e.transactionHash === txHash);
    if (!evt) { setStatus('Error: no matching event'); return; }

    const { results, win } = evt.args;

    results.forEach(id => {
      const f = faces.find(x => x.id === id);
      const img = document.createElement('img');
      img.src = `game/${f.src}`;
      res.appendChild(img);
    });

    const msg = document.createElement('p');
    msg.innerText = `You won: ${ethers.formatUnits(win, 18)} MON`;
    res.appendChild(msg);

    setStatus('Result from this transaction');
  }

  function setStatus(message) {
    document.getElementById("status").innerText = message;
  }
</script>
</body>
</html>
